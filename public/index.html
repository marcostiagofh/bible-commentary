<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Coment√°rio B√≠blico ‚Äî Navegador Local</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<style>
  /* small custom tweaks */
  :root {
    --page-bg: #111827; /* gray-900 */
    --box-bg: #1F2937; /* gray-800 */
    --text-color: #F3F4F6; /* gray-100 */
    --input-bg: #1F2937; /* gray-800 */
    --input-text: #F3F4F6; /* gray-100 */
  }

  .day-mode {
    --page-bg: rgb(233, 208, 167);
    --box-bg: rgb(243, 242, 237);
    --text-color: rgb(161, 0, 41);
    --input-bg: #fff;
    --input-text: #000;
  }

  body { background-color: var(--page-bg); color: var(--text-color); transition: background-color 0.3s, color 0.3s; }
  .box { background-color: var(--box-bg); color: var(--text-color); transition: background-color 0.3s, color 0.3s; }
  .book-item:hover { background: rgba(255,255,255,0.03); }
  .chapter-item:hover { background: rgba(255,255,255,0.03); }
  .file-item:hover { background: rgba(255,255,255,0.03); }
  pre { white-space: pre-wrap; }
  /* Estilo para a frase destacada durante a leitura */
  .highlight-speech {
    background-color: rgba(96, 165, 250, 0.5); /* Azul claro semi-transparente */
    transition: background-color 0.2s ease-in-out;
  }
  /* Estilos para barras de rolagem mais discretas (WebKit) */
  ::-webkit-scrollbar {
    width: 8px;
    height: 8px;
  }
  ::-webkit-scrollbar-track {
    background: transparent;
  }
  ::-webkit-scrollbar-thumb {
    background-color: rgba(255, 255, 255, 0.2);
    border-radius: 4px;
  }
  ::-webkit-scrollbar-thumb:hover {
    background-color: rgba(255, 255, 255, 0.4);
  }
</style>
<body class="font-sans p-4">
  <div class="flex flex-col md:flex-row md:h-screen md:max-h-screen gap-4">
    <!-- Coluna de Livros -->
    <div class="box flex-shrink-0 md:flex-none md:w-64 p-4 rounded-lg flex flex-col">
      <h2 class="text-xl font-bold mb-4" style="color: var(--text-color);">Livros</h2>
      <input id="filterBook" placeholder="filtrar livros..." class="w-full p-2 mb-3 rounded" style="background-color: var(--input-bg); color: var(--input-text);" />
      <div id="books" class="space-y-1 overflow-y-auto h-32 md:h-auto md:flex-1"></div>
    </div>
    <!-- Coluna de Cap√≠tulos -->
    <div class="box flex-shrink-0 md:flex-none md:w-64 p-4 rounded-lg flex flex-col">
      <h2 class="text-xl font-bold mb-4" style="color: var(--text-color);">Cap√≠tulos</h2>
      <div id="chapters" class="space-y-1 overflow-y-auto h-32 md:h-auto md:flex-1"></div>
    </div>
    <!-- Coluna de Trechos -->
    <div class="box flex-shrink-0 md:flex-none md:w-64 p-4 rounded-lg flex flex-col">
      <h2 class="text-xl font-bold mb-4" style="color: var(--text-color);">Trechos / Arquivos</h2>
      <div id="files" class="space-y-1 overflow-y-auto h-32 md:h-auto md:flex-1"></div>
    </div>

    <!-- √Årea de Leitura (ocupa o resto do espa√ßo) -->
    <main class="box flex-1 p-4 rounded-lg flex flex-col overflow-hidden">
      <div class="flex flex-col sm:flex-row justify-between items-start mb-2 gap-4">
        <div>
          <h2 id="readerTitle" class="text-2xl font-bold" style="color: var(--text-color);">Selecione um trecho</h2>
          <p id="readerSub" class="text-sm mt-1"></p>
        </div>
        <div class="flex flex-wrap gap-2 items-center">
          <button id="btnPlayPause" class="px-3 py-1 bg-blue-600 rounded w-28 text-center">‚ñ∂Ô∏è Ler</button>
          <button id="btnStop" class="px-3 py-1 bg-red-600 rounded">‚èπÔ∏è Parar</button>
          <select id="voiceSelect" class="bg-gray-700 text-white rounded px-2 py-1 text-sm"></select>
          <button id="btnMusic" class="px-3 py-1 bg-green-600 rounded w-28 text-center">üéµ</button>
        </div>
        <button id="themeToggle" class="px-3 py-1 bg-gray-600 rounded">‚òÄÔ∏è / üåô</button>
      </div>
      <div class="prose max-w-none flex-1 overflow-y-auto">
        <pre id="content" class="text-sm leading-6" style="color: var(--text-color);"></pre>
      </div>
      <!-- Caixa para exibir vers√≠culos clicados -->
      <div id="verse-display-container" class="box mt-4 p-4 rounded-lg hidden flex-col max-h-64">
          <h3 class="text-lg font-bold mb-2" style="color: var(--text-color);">Texto do Vers√≠culo</h3>
          <div class="flex-1 overflow-y-auto">
              <pre id="verse-display" class="text-sm leading-6" style="color: var(--text-color);"></pre>
          </div>
      </div>
    </main>
  </div>

  <!-- Player do YouTube oculto -->
  <div id="youtube-player" style="display: none;"></div>

<script>
// Global data store
let bibleData = {};
let currentBook = null;
let currentChapter = null;
let currentFilePath = null;
let isAutoplayEnabled = true; // Controle para a reprodu√ß√£o cont√≠nua
let musicPlayer; // Vari√°vel para o player de m√∫sica do YouTube
let bibleVerseData = {}; // Para armazenar o data_biblia.json

function el(tag, attrs={}, txt=''){
  const e = document.createElement(tag);
  for(const k in attrs) e.setAttribute(k, attrs[k]);
  if (txt) e.textContent = txt;
  return e;
}

function loadBooks(){
  const booksDiv = document.getElementById('books');
  booksDiv.innerHTML='';
  const filter = document.getElementById('filterBook');
  const books = Object.keys(bibleData);
  function render(){
    booksDiv.innerHTML='';
    const q = filter.value.toLowerCase();
    books.filter(b=>b.toLowerCase().includes(q)).forEach(b=>{
      const row = el('div',{class:'p-2 rounded cursor-pointer book-item'}, b);
      row.onclick = ()=> selectBook(b);
      booksDiv.appendChild(row);
    });
  }
  filter.oninput = render;
  render();
}

function selectBook(book){
  currentBook = book;
  document.getElementById('readerTitle').textContent = book;
  document.getElementById('readerSub').textContent = '';
  // load chapters
  const chDiv = document.getElementById('chapters');
  chDiv.innerHTML='';
  const chapters = Object.keys(bibleData[book]);
  chapters.forEach(ch=>{
    const r = el('div',{class:'p-2 rounded cursor-pointer chapter-item'}, ch);
    r.onclick = ()=> selectChapter(book, ch);
    chDiv.appendChild(r);
  });
  // clear files and content
  document.getElementById('files').innerHTML='';
  document.getElementById('content').textContent='';
}

function selectChapter(book, chapter){
  currentChapter = chapter;
  document.getElementById('readerSub').textContent = `${book} ‚Äî ${chapter}`;
  const filesDiv = document.getElementById('files');
  filesDiv.innerHTML='';
  const files = Object.keys(bibleData[book][chapter]);
  files.forEach(f=>{
    const r = el('div',{class:'p-2 rounded cursor-pointer file-item'}, f);
    r.onclick = ()=> loadFile(book, chapter, f);
    filesDiv.appendChild(r);
  });
  document.getElementById('content').textContent='';
}

function loadFile(book, chapter, filename){
  currentBook = book;
  currentChapter = chapter;
  currentFilePath = filename;
  document.getElementById('content').textContent = bibleData[book][chapter][filename];
  document.getElementById('readerTitle').textContent = filename.replace(/\.txt$/i, '');
  makeReferencesClickable();
}

function findNextItem() {
  if (!currentBook || !currentChapter || !currentFilePath) return null;

  const booksList = Object.keys(bibleData);
  const chaptersList = Object.keys(bibleData[currentBook]);
  const filesList = Object.keys(bibleData[currentBook][currentChapter]);

  const currentFileIndex = filesList.indexOf(currentFilePath);

  // 1. Tenta encontrar o pr√≥ximo arquivo no mesmo cap√≠tulo
  if (currentFileIndex < filesList.length - 1) {
    const nextFile = filesList[currentFileIndex + 1];
    return { book: currentBook, chapter: currentChapter, file: nextFile };
  }

  // 2. Se n√£o houver, tenta encontrar o pr√≥ximo cap√≠tulo no mesmo livro
  const currentChapterIndex = chaptersList.indexOf(currentChapter);
  if (currentChapterIndex < chaptersList.length - 1) {
    const nextChapter = chaptersList[currentChapterIndex + 1];
    const nextChapterFiles = Object.keys(bibleData[currentBook][nextChapter]);
    if (nextChapterFiles.length > 0) {
      return { book: currentBook, chapter: nextChapter, file: nextChapterFiles[0] };
    }
  }

  // 3. Se n√£o houver, tenta encontrar o pr√≥ximo livro
  const currentBookIndex = booksList.indexOf(currentBook);
  if (currentBookIndex < booksList.length - 1) {
    const nextBook = booksList[currentBookIndex + 1];
    const nextBookChapters = Object.keys(bibleData[nextBook]);
    if (nextBookChapters.length > 0) {
      const nextChapter = nextBookChapters[0];
      const nextChapterFiles = Object.keys(bibleData[nextBook][nextChapter]);
      if (nextChapterFiles.length > 0) {
        return { book: nextBook, chapter: nextChapter, file: nextChapterFiles[0] };
      }
    }
  }

  // 4. Chegou ao fim de tudo
  return null;
}

function playNext() {
    const nextItem = findNextItem();
    if (nextItem) {
        selectBook(nextItem.book);
        selectChapter(nextItem.book, nextItem.chapter);
        loadFile(nextItem.book, nextItem.chapter, nextItem.file);
        handlePlayPause(); // Inicia a leitura do novo trecho
    }
}
const synth = window.speechSynthesis;
  let voices = [];
  // Vari√°veis para controlar o estado da fala
  let currentUtterance = null;
  let originalTextForSpeech = '';

  // Fun√ß√£o que popula o seletor de vozes
  function populateVoiceList() {
    const allVoices = synth.getVoices();
    const newVoices = allVoices.filter(voice => voice.lang.toLowerCase().includes('pt-'));

    const voiceSelect = document.getElementById('voiceSelect');

    // Armazena o URI da voz atualmente selecionada antes de limpar o dropdown
    let previouslySelectedVoiceURI = null;
    if (voiceSelect.value !== '' && voices.length > 0) { // 'voices' aqui se refere √† lista global *antiga*
        const currentVoiceOptionIndex = parseInt(voiceSelect.value, 10);
        if (currentVoiceOptionIndex >= 0 && currentVoiceOptionIndex < voices.length) {
            previouslySelectedVoiceURI = voices[currentVoiceOptionIndex].voiceURI;
        }
    }

    // Atualiza a vari√°vel global 'voices' com a nova lista filtrada
    voices = newVoices;

    voiceSelect.innerHTML = ''; // limpar

    // Itera sobre a lista j√° filtrada de vozes em portugu√™s
    voices.forEach((voice, i) => {
      const option = document.createElement('option');
      option.textContent = `${voice.name} (${voice.lang})`;
      option.value = i; // O valor da op√ß√£o √© o √≠ndice na lista 'voices'
      voiceSelect.appendChild(option);
    });

    // Tenta re-selecionar a voz que estava ativa
    if (previouslySelectedVoiceURI) {
      const newIndex = voices.findIndex(v => v.voiceURI === previouslySelectedVoiceURI);
      if (newIndex !== -1) {
        voiceSelect.selectedIndex = newIndex;
      } else {
        // Se a voz anterior n√£o estiver mais dispon√≠vel, seleciona a primeira
        voiceSelect.selectedIndex = 0;
      }
    } else {
      // Se nada estava selecionado (primeira carga), seleciona a primeira
      voiceSelect.selectedIndex = 0;
    }
  }

  populateVoiceList();
  if (speechSynthesis.onvoiceschanged !== undefined) {
    speechSynthesis.onvoiceschanged = populateVoiceList;
  }

  // Fun√ß√£o para destacar a palavra/frase durante a fala
  function highlightText(event) {
    const contentEl = document.getElementById('content');
    
    if (event.name === 'word') {
        const start = event.charIndex;
        const end = start + event.charLength;

        // Recria o HTML com a parte destacada
        const before = originalTextForSpeech.substring(0, start);
        const highlighted = originalTextForSpeech.substring(start, end);
        const after = originalTextForSpeech.substring(end);

        contentEl.innerHTML = `${escapeHtml(before)}<span class="highlight-speech">${escapeHtml(highlighted)}</span>${escapeHtml(after)}`;
      }
    };

  // Fun√ß√£o principal que gerencia Play/Pause/Resume
  function handlePlayPause() {
    const btn = document.getElementById('btnPlayPause');
    const contentEl = document.getElementById('content');

    if (synth.paused && currentUtterance) {
      // Se estiver pausado, retoma
      synth.resume();
      btn.textContent = '‚è∏Ô∏è Pausar';
    } else if (synth.speaking) {
      // Se estiver falando, pausa
      synth.pause();
      btn.textContent = '‚ñ∂Ô∏è Retomar';
    } else {
      // Se n√£o estiver falando, come√ßa do in√≠cio
      originalTextForSpeech = contentEl.innerText;
      if (originalTextForSpeech.trim() === '') return;

      synth.cancel(); // Garante que qualquer fala anterior seja interrompida

      currentUtterance = new SpeechSynthesisUtterance(originalTextForSpeech);

      // Configura√ß√µes da voz e da fala
      const selectedIndex = document.getElementById('voiceSelect').value;
      currentUtterance.voice = voices[selectedIndex];
      currentUtterance.rate = 0.9;
      currentUtterance.pitch = 1.0;
      currentUtterance.volume = 1.0;

      // Adiciona os eventos para o novo utterance
      currentUtterance.onboundary = highlightText;
      currentUtterance.onend = () => {
        contentEl.innerHTML = escapeHtml(originalTextForSpeech);
        btn.textContent = '‚ñ∂Ô∏è Ler';
        currentUtterance = null;
        // Se o autoplay estiver ativo, toca o pr√≥ximo
        if (isAutoplayEnabled) {
            playNext();
        }
      };

      synth.speak(currentUtterance);
      btn.textContent = '‚è∏Ô∏è Pausar';
    }
  }

  function escapeHtml(unsafe) {
    return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&#039;");
  }

  function handleStop() {
    synth.cancel(); // Isso tamb√©m aciona o evento 'onend'
    currentUtterance = null;
  }

  // Eventos dos bot√µes
  document.getElementById('btnPlayPause').addEventListener('click', handlePlayPause);
  document.getElementById('btnStop').addEventListener('click', handleStop);
  document.getElementById('themeToggle').addEventListener('click', toggleTheme);
  document.getElementById('content').addEventListener('click', handleVerseClick);
  document.getElementById('btnMusic').addEventListener('click', toggleMusic);

  function toggleTheme() {
    document.body.classList.toggle('day-mode');
    // Salva a prefer√™ncia no localStorage
    if (document.body.classList.contains('day-mode')) {
      localStorage.setItem('theme', 'day');
    } else {
      localStorage.setItem('theme', 'night');
    }
  }

  function applyInitialTheme() {
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'day') {
      document.body.classList.add('day-mode');
    } // O modo noturno √© o padr√£o, ent√£o n√£o precisa de 'else'
  }

  // --- L√≥gica para buscar e exibir vers√≠culos ---

  const livros_biblia = ["G√™nesis", "√äxodo", "Lev√≠tico", "N√∫meros", "Deuteron√¥mio", "Josu√©", "Ju√≠zes", "Rute", "1 Samuel", "2 Samuel", "1 Reis", "2 Reis", "1 Cr√¥nicas", "2 Cr√¥nicas", "Esdras", "Neemias", "Ester", "J√≥", "Salmos", "Prov√©rbios", "Eclesiastes", "C√¢ntico Dos C√¢nticos", "Isa√≠as", "Jeremias", "Lamenta√ß√µes", "Ezequiel", "Daniel", "Os√©ias", "Joel", "Am√≥s", "Obadias", "Jonas", "Miqu√©ias", "Naum", "Habacuque", "Sofonias", "Ageu", "Zacarias", "Malaquias", "Mateus", "Marcos", "Lucas", "Jo√£o", "Atos", "Romanos", "1 Cor√≠ntios", "2 Cor√≠ntios", "G√°latas", "Ef√©sios", "Filipenses", "Colossenses", "1 Tessalonicenses", "2 Tessalonicenses", "1 Tim√≥teo", "2 Tim√≥teo", "Tito", "Filemom", "Hebreus", "Tiago", "1 Pedro", "2 Pedro", "1 Jo√£o", "2 Jo√£o", "3 Jo√£o", "Judas", "Apocalipse"];
  
  const abreviacoes = [
  "Gn","√äx","Lv","Nm","Dt","Js","Jz","Rt","1 Sm","2 Sm","1 Rs","2 Rs","1 Cr","2 Cr","Ed","Ne","Et","J√≥",
  "Sl","Pv","Ec","Ct","Is","Jr","Lm","Ez","Dn","Os","Jl","Am","Ob","Jn","Mq","Na","Hc","Sf","Ag","Zc","Ml",
  "Mt","Mc","Lc","Jo","At","Rm","1 Co","2 Co","Gl","Ef","Fp","Cl","1 Ts","2 Ts","1 Tm","2 Tm","Tt","Fm","Hb","Tg",
  "1 Pe","2 Pe","1 Jo","2 Jo","3 Jo","Jd","Ap"
  ];

  // Mapa para buscar √≠ndice por nome ou abrevia√ß√£o
  const livroMap = {};
  livros_biblia.forEach((nome, i) => {
    livroMap[nome.toLowerCase()] = i + 1;
    livroMap[abreviacoes[i].toLowerCase()] = i + 1;
  });


  // Gera o regex a partir da lista de livros
  const verseRegex = new RegExp(`\\b(${[...livros_biblia, ...abreviacoes].join('|')})\\s+(\\d+)\\.(\\d+)(?:[,-](\\d+))?`, 'gi');

  function makeReferencesClickable() {
    const contentEl = document.getElementById('content');
    let html = contentEl.textContent; // Usar textContent para evitar problemas com HTML j√° existente
    
    // Substitui as refer√™ncias por links clic√°veis
    html = html.replace(verseRegex, (match) => {
        return `<a href="#" class="verse-link text-blue-400 hover:underline" data-ref="${match}">${match}</a>`;
    });

    contentEl.innerHTML = html;
  }

  async function handleVerseClick(event) {
      if (event.target.classList.contains('verse-link')) {
          event.preventDefault();
          const ref = event.target.dataset.ref;
          
          const verseDisplayContainer = document.getElementById('verse-display-container');
          const verseDisplay = document.getElementById('verse-display');
          
          verseDisplay.textContent = 'Buscando...';
          verseDisplayContainer.classList.remove('hidden');
          verseDisplayContainer.classList.add('flex');

          const text = await fetchVerseText(ref);
          verseDisplay.textContent = text || `Refer√™ncia n√£o encontrada: ${ref}`;
      }
  }

  function fetchVerseText(ref) {
    // Parse da refer√™ncia: Ex: "G√™nesis 1:1-3"
    // Usamos o mesmo regex, mas ancorado com ^ e $ para garantir que a string inteira corresponda.
    const parsingRegex = new RegExp(`^(${[...livros_biblia, ...abreviacoes].join('|')})\\s+(\\d+)\\.(\\d+)(?:[,-](\\d+))?$`);
    const match = ref.match(parsingRegex);

    if (!match) return `Refer√™ncia inv√°lida: "${ref}"`;

    let [, bookName, chapterNum, startVerse, endVerse] = match;
    const endVerseNum = parseInt(endVerse || startVerse, 10);
    const startVerseNum = parseInt(startVerse, 10);

    // 1. Encontrar a chave correta do livro em bibleVerseData (ex: "01 - G√™nesis")
    const bookIndex = livroMap[bookName.toLowerCase()];
    bookName = livros_biblia[bookIndex - 1];
    const bookKey = Object.keys(bibleVerseData).find(k => k.startsWith(String(bookIndex).padStart(2, '0')));
    if (!bookKey || !bibleVerseData[bookKey]) {
        console.error(`Chave do livro n√£o encontrada para: ${bookName}`);
        return null;
    }

    // 2. Encontrar a chave correta do cap√≠tulo (ex: "001 - CAP√çTULO 1")
    const chapterKey = Object.keys(bibleVerseData[bookKey]).find(k => {
        const num = k.split(' ')[0];
        return parseInt(num, 10) === parseInt(chapterNum, 10);
    });
    console.log('bookKey:', bookKey);
    console.log('chapterKey:', chapterKey);
    console.log('bibleVerseData:', [bookKey][chapterKey]);
    if (!chapterKey || !bibleVerseData[bookKey][chapterKey]) {
        console.error(`Chave do cap√≠tulo n√£o encontrada para: ${chapterNum} em ${bookKey}`);
        return null;
    }

    const chapterData = bibleVerseData[bookKey][chapterKey];
    let concatenatedText = '';

    // 3. Iterar e concatenar os vers√≠culos
    for (let i = startVerseNum; i <= endVerseNum; i++) {
        const verseFileName = `${String(i)}.txt`;
        if (chapterData[verseFileName]) {
            concatenatedText += `[${i}] ${chapterData[verseFileName]}\n`;
        } else {
            concatenatedText += `[${i}] -- Vers√≠culo n√£o encontrado --\n`;
        }
    }

    return concatenatedText.trim();
  }

  // --- L√≥gica da M√∫sica de Fundo (YouTube) ---

  // 1. Esta fun√ß√£o cria o <iframe> e o player do YouTube
  //    depois que o c√≥digo da API √© baixado.
  function onYouTubeIframeAPIReady() {
    musicPlayer = new YT.Player('youtube-player', {
      height: '0',
      width: '0', 
      playerVars: {
        // Para tocar uma playlist, usamos 'listType' e 'list'
        'listType': 'playlist',
        // Este √© o ID da sua playlist
        'list': 'PLEpUe48oZgzbYuBdeg44ogoyraQiKNPB2',
        'playsinline': 1
      }
    });
  }

  // 2. Fun√ß√£o para controlar a reprodu√ß√£o da m√∫sica
  function toggleMusic() {
    if (!musicPlayer || typeof musicPlayer.getPlayerState !== 'function') {
      console.log("Player de m√∫sica ainda n√£o est√° pronto.");
      return;
    }
    const playerState = musicPlayer.getPlayerState();
    const btnMusic = document.getElementById('btnMusic');

    if (playerState === YT.PlayerState.PLAYING) {
      musicPlayer.pauseVideo();
      btnMusic.textContent = 'üéµ';
    } else {
      musicPlayer.playVideo();
      btnMusic.textContent = 'üîá';
    }
  }

async function main() {
  try {
    const response = await fetch('./data.json');
    if (!response.ok) throw new Error(`Failed to load data.json: ${response.statusText}`);
    bibleData = await response.json();
    
    // Carrega os dados da b√≠blia para os vers√≠culos
    try {
        const bibleResponse = await fetch('./data_biblia.json');
        if (bibleResponse.ok) {
            bibleVerseData = await bibleResponse.json();
        } else {
            console.warn('data_biblia.json n√£o encontrado. A funcionalidade de clique em vers√≠culos estar√° desativada.');
        }
    } catch (e) {
        console.warn('Erro ao carregar data_biblia.json:', e);
    }
    applyInitialTheme();
    loadBooks();
  } catch (e) {
    console.error(e);
    alert('Erro fatal: N√£o foi poss√≠vel carregar os dados do coment√°rio. Execute o script de build (node build.js) e verifique se o arquivo data.json existe na pasta public.');
  }
}

// Carrega a API do IFrame Player do YouTube de forma ass√≠ncrona.
const tag = document.createElement('script');
tag.src = "https://www.youtube.com/iframe_api";
const firstScriptTag = document.getElementsByTagName('script')[0];
firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

main();
</script>

</body>
</html>