<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Coment√°rio B√≠blico ‚Äî Navegador Local</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<style>
  /* small custom tweaks */
  .book-item:hover { background: rgba(255,255,255,0.03); }
  .chapter-item:hover { background: rgba(255,255,255,0.03); }
  .file-item:hover { background: rgba(255,255,255,0.03); }
  pre { white-space: pre-wrap; }
  /* Estilo para a frase destacada durante a leitura */
  .highlight-speech {
    background-color: rgba(96, 165, 250, 0.5); /* Azul claro semi-transparente */
    transition: background-color 0.2s ease-in-out;
  }
  /* Estilos para barras de rolagem mais discretas (WebKit) */
  ::-webkit-scrollbar {
    width: 8px;
    height: 8px;
  }
  ::-webkit-scrollbar-track {
    background: transparent;
  }
  ::-webkit-scrollbar-thumb {
    background-color: rgba(255, 255, 255, 0.2);
    border-radius: 4px;
  }
  ::-webkit-scrollbar-thumb:hover {
    background-color: rgba(255, 255, 255, 0.4);
  }
</style>
<body class="bg-gray-900 text-gray-100 font-sans p-4">
  <div class="flex flex-col md:flex-row md:h-screen md:max-h-screen gap-4">
    <!-- Coluna de Livros -->
    <div class="flex-shrink-0 md:flex-none md:w-64 bg-gray-800 p-4 rounded-lg flex flex-col">
      <h2 class="text-xl font-bold mb-4">Livros</h2>
      <input id="filterBook" placeholder="filtrar livros..." class="w-full p-2 mb-3 text-gray-900 rounded" />
      <div id="books" class="space-y-1 overflow-y-auto h-32 md:h-auto md:flex-1"></div>
    </div>
    <!-- Coluna de Cap√≠tulos -->
    <div class="flex-shrink-0 md:flex-none md:w-64 bg-gray-800 p-4 rounded-lg flex flex-col">
      <h2 class="text-xl font-bold mb-4">Cap√≠tulos</h2>
      <div id="chapters" class="space-y-1 overflow-y-auto h-32 md:h-auto md:flex-1"></div>
    </div>
    <!-- Coluna de Trechos -->
    <div class="flex-shrink-0 md:flex-none md:w-64 bg-gray-800 p-4 rounded-lg flex flex-col">
      <h2 class="text-xl font-bold mb-4">Trechos / Arquivos</h2>
      <div id="files" class="space-y-1 overflow-y-auto h-32 md:h-auto md:flex-1"></div>
    </div>

    <!-- √Årea de Leitura (ocupa o resto do espa√ßo) -->
    <main class="flex-1 bg-gray-800 p-4 rounded-lg flex flex-col overflow-hidden">
      <div class="flex flex-col sm:flex-row justify-between items-start mb-2 gap-4">
        <div>
          <h2 id="readerTitle" class="text-2xl font-bold">Selecione um trecho</h2>
          <p id="readerSub" class="text-sm text-gray-300 mt-1"></p>
        </div>
        <div class="flex flex-wrap gap-2 items-center">
          <button id="btnSpeak" class="px-3 py-1 bg-blue-600 rounded">üîä Ler</button>
          <button id="btnStop" class="px-3 py-1 bg-red-600 rounded">‚èπÔ∏è Parar</button>
          <select id="voiceSelect" class="bg-gray-700 text-white rounded px-2 py-1 text-sm"></select>
        </div>
      </div>
      <div class="prose max-w-none text-gray-100 flex-1 overflow-y-auto">
        <pre id="content" class="text-sm leading-6"></pre>
      </div>
    </main>
  </div>

<script>
// Global data store
let bibleData = {};
let currentBook = null;
let currentChapter = null;
let currentFilePath = null;

function el(tag, attrs={}, txt=''){
  const e = document.createElement(tag);
  for(const k in attrs) e.setAttribute(k, attrs[k]);
  if (txt) e.textContent = txt;
  return e;
}

function loadBooks(){
  const booksDiv = document.getElementById('books');
  booksDiv.innerHTML='';
  const filter = document.getElementById('filterBook');
  const books = Object.keys(bibleData);
  function render(){
    booksDiv.innerHTML='';
    const q = filter.value.toLowerCase();
    books.filter(b=>b.toLowerCase().includes(q)).forEach(b=>{
      const row = el('div',{class:'p-2 rounded cursor-pointer book-item'}, b);
      row.onclick = ()=> selectBook(b);
      booksDiv.appendChild(row);
    });
  }
  filter.oninput = render;
  render();
}

function selectBook(book){
  currentBook = book;
  document.getElementById('readerTitle').textContent = book;
  document.getElementById('readerSub').textContent = '';
  // load chapters
  const chDiv = document.getElementById('chapters');
  chDiv.innerHTML='';
  const chapters = Object.keys(bibleData[book]);
  chapters.forEach(ch=>{
    const r = el('div',{class:'p-2 rounded cursor-pointer chapter-item'}, ch);
    r.onclick = ()=> selectChapter(book, ch);
    chDiv.appendChild(r);
  });
  // clear files and content
  document.getElementById('files').innerHTML='';
  document.getElementById('content').textContent='';
}

function selectChapter(book, chapter){
  currentChapter = chapter;
  document.getElementById('readerSub').textContent = `${book} ‚Äî ${chapter}`;
  const filesDiv = document.getElementById('files');
  filesDiv.innerHTML='';
  const files = Object.keys(bibleData[book][chapter]);
  files.forEach(f=>{
    const r = el('div',{class:'p-2 rounded cursor-pointer file-item'}, f);
    r.onclick = ()=> loadFile(book, chapter, f);
    filesDiv.appendChild(r);
  });
  document.getElementById('content').textContent='';
}

function loadFile(book, chapter, filename){
  currentBook = book;
  currentChapter = chapter;
  currentFilePath = filename;
  document.getElementById('content').textContent = bibleData[book][chapter][filename];
  document.getElementById('readerTitle').textContent = filename.replace(/\.txt$/i, '');
}

const synth = window.speechSynthesis;
  let voices = [];

  // Fun√ß√£o que popula o seletor de vozes
  function populateVoiceList() {
    voices = synth.getVoices();
    const voiceSelect = document.getElementById('voiceSelect');
    voiceSelect.innerHTML = ''; // limpar

    voices.forEach((voice, i) => {
      const option = document.createElement('option');
      option.textContent = `${voice.name} (${voice.lang})`;
      option.value = i;
      voiceSelect.appendChild(option);
    });

    // Seleciona automaticamente uma voz em portugu√™s
    const preferred = voices.findIndex(v => /pt|brazil/i.test(v.lang));
    if (preferred >= 0) voiceSelect.selectedIndex = preferred;
  }

  populateVoiceList();
  if (speechSynthesis.onvoiceschanged !== undefined) {
    speechSynthesis.onvoiceschanged = populateVoiceList;
  }

  // Fun√ß√£o para falar o texto
  function speakText() {
    const contentEl = document.getElementById('content');
    const originalText = contentEl.innerText;

    if (originalText.trim() === '') return;

    synth.cancel(); // parar o que estiver tocando
    const utterance = new SpeechSynthesisUtterance(originalText);

    // Escolher a voz selecionada
    const selectedIndex = document.getElementById('voiceSelect').value;
    utterance.voice = voices[selectedIndex];

    // Configura√ß√µes de naturalidade
    utterance.rate = 0.9; // velocidade
    utterance.pitch = 1.0; // tom
    utterance.volume = 1.0; // volume m√°ximo

    // Evento para destacar a frase atual
    utterance.onboundary = (event) => {
      if (event.name === 'word') {
        const start = event.charIndex;
        const end = start + event.charLength;

        // Recria o HTML com a parte destacada
        const before = originalText.substring(0, start);
        const highlighted = originalText.substring(start, end);
        const after = originalText.substring(end);

        contentEl.innerHTML = `${escapeHtml(before)}<span class="highlight-speech">${escapeHtml(highlighted)}</span>${escapeHtml(after)}`;
      }
    };

    // Evento para limpar o destaque no final
    utterance.onend = () => {
      contentEl.innerHTML = escapeHtml(originalText);
    };

    synth.speak(utterance);
  }

  function escapeHtml(unsafe) {
    return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&#039;");
  }

  // Eventos dos bot√µes
  document.getElementById('btnSpeak').addEventListener('click', speakText);

document.getElementById('btnStop').addEventListener('click', () => synth.cancel());

async function main() {
  try {
    const response = await fetch('./data.json');
    if (!response.ok) throw new Error(`Failed to load data.json: ${response.statusText}`);
    bibleData = await response.json();
    loadBooks();
  } catch (e) {
    console.error(e);
    alert('Erro fatal: N√£o foi poss√≠vel carregar os dados do coment√°rio. Execute o script de build (node build.js) e verifique se o arquivo data.json existe na pasta public.');
  }
}

main();
</script>
</body>
</html>